events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    # Upstreams matching Docker Compose service names
    upstream auth_service { server auth-service:3001; }
    upstream document_service { server document-service:3002; }
    upstream billing_service { server billing-service:3003; }
    upstream query_service { server query-service:3004; }
    upstream analytics_service { server analytics-service:3005; }
    upstream chat_service { server chat-service:3006; }
    upstream notification_service { server notification-service:3007; }

    # Node Gateway for Aggregation (if needed)
    upstream node_gateway { server api-gateway-node:3000; }

    server {
        listen 80;
        server_name localhost;

        # --- REST Services ---
        location /api/v1/auth {
            proxy_pass http://auth_service/auth;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/v1/documents {
            proxy_pass http://document_service/documents;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /api/v1/billing {
            proxy_pass http://billing_service/billing;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --- GraphQL Services ---
        # For now, routing /graphql to Node which should aggregate Query & Analytics
        location /graphql {
            proxy_pass http://node_gateway/graphql;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # --- WebSocket Services ---
        # Chat
        location /ws/chat {
            proxy_pass http://chat_service/socket.io;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Notifications
        location /ws/notifications {
            proxy_pass http://notification_service/socket.io;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        # Health Check
        location /health {
            return 200 '{"status":"ok", "architecture":"microservices"}';
            add_header Content-Type application/json;
        }
    }
}
